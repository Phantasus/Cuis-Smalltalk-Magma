MaObject subclass: #MagmaBufferController	instanceVariableNames: 'session primitiveAttributes bufferFacades commitRecords'	classVariableNames: ''	poolDictionaries: ''	category: 'Magma-Tools-Buffer Editor'!!MagmaBufferController commentStamp: 'cmm 3/15/2009 18:47' prior: 0!This is a tool for browsing the actual MaObjectBuffers that make up each object of a Magma repoitory.I help by presenting the physical domain-model as a graph of MagmaBufferFacades.  Each facade represents exactly one MaObjectBuffer, which is the primary unit-of-storage for a single object stored in Magma.  The facade provides as much information about the real object-model as possible, such as the class name or string contents if it is a String.Should you be unable to open a repository you may build up my classMap as you uncover class-ids using clues from the buffers (for example, since all String buffers are automatically shown, you may recognize a reference to a particular String and identify the class-id of its referencer that way).My 'cache' preserves facade identity, therefore allowing Maui to show the graph-shape with reference lines.To use, you specify the location of the repository (or your own MagmaSession if you wish).!!MagmaBufferController methodsFor: 'root buffers' stamp: 'cmm 3/14/2009 14:57'!anchorBuffer	^ self bufferAt: (self primitiveAttributes at: #anchorOid)! !!MagmaBufferController methodsFor: 'root buffers' stamp: 'cmm 3/14/2009 15:01'!classDefinitionsBuffer	^ self bufferAt: (self primitiveAttributes at: #classDefinitionsOid)! !!MagmaBufferController methodsFor: 'root buffers' stamp: 'cmm 3/14/2009 15:01'!repositoryDefinitionBuffer	^ self bufferAt: (self primitiveAttributes at: #definitionOid)! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 3/16/2014 18:08'!bufferAt: anInteger 	^ bufferFacades 		at: anInteger		ifAbsentPut: [ self newFacadeFor: anInteger ]! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 6/19/2013 13:30'!buffersInCommit: commitNumber 	"The MaCommitLogEntry that contained this buffer."	^ (session commitPackageAt: commitNumber) ifNotNilDo: 		[ : cp | 		| answer |		answer := OrderedCollection new.		cp objectsDo: 			[ : eachBuffer | 			answer add:				(MagmaBufferFacade					buffer: eachBuffer copyWithSameBuffer					controller: self) ].		answer ]! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 3/15/2009 19:45'!cacheSize	^ {  (bufferFacades size). (commitRecords size)  }! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 3/14/2009 14:43'!classDefinitionFor: classIdInteger version: versionInteger 	^ 	[ self classIdManager 		definitionForClassId: classIdInteger		version: versionInteger ] 		on: Error		do: 			[ : err | 			(MaClassDefinition className: '(id=' , classIdInteger printString , ', v=' , versionInteger printString , ') unknown')				id: classIdInteger ;				version: versionInteger ;				yourself ]! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 6/19/2013 13:12'!commitLogEntryAt: commitNumber	"The MaCommitLogEntry that contained this buffer."	^ (self commitRecordAt: commitNumber) ifNotNilDo: [ : cr | MagmaSession materializeCommitLogEntry: cr ]! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 4/14/2009 14:16'!commitNumber	^ session remoteCommitNumber! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 6/19/2013 13:18'!commitRecordAt: commitNumber 	^ commitRecords 		at: commitNumber		ifAbsent: 			[ 			[ commitRecords 				at: commitNumber				put: (session commitLogRecordAt: commitNumber) ] 				on: MagmaUnavailableCommitRecord				do: [ : err | nil ] ]! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 4/14/2009 14:19'!location	^ session location! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 3/14/2009 15:31'!objectClassNameFor: classIdInteger 	^ (self classIdManager 		classDefinitionsForId: classIdInteger		ifAbsent: [ ^ (classIdInteger , ' - unknown classId') asString ]) last name! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 3/14/2009 15:00'!primitiveAttributes	^ primitiveAttributes ifNil: [ primitiveAttributes := session remotePrimitiveAttributes ]! !!MagmaBufferController methodsFor: 'access' stamp: 'cmm 3/16/2014 19:33'!session	^ session! !!MagmaBufferController methodsFor: 'private' stamp: 'cmm 3/22/2005 23:25'!classIdManager	^ self serializer classIdManager! !!MagmaBufferController methodsFor: 'private' stamp: 'cmm 3/16/2014 18:08'!newFacadeFor: oidInteger 	^ MagmaBufferFacade		buffer: (session bufferForOid: oidInteger)		controller: self! !!MagmaBufferController methodsFor: 'private' stamp: 'cmm 3/14/2009 14:41'!serializer	^ session serializer! !!MagmaBufferController methodsFor: 'initializing' stamp: 'cmm 3/14/2009 15:29'!disconnect	session disconnect! !!MagmaBufferController methodsFor: 'initializing' stamp: 'cmm 3/14/2009 15:30'!disconnectAndClose	session disconnectAndClose! !!MagmaBufferController methodsFor: 'initializing' stamp: 'cmm 6/19/2013 13:12'!initialize	super initialize.	bufferFacades := Dictionary new.	commitRecords := Dictionary new! !!MagmaBufferController methodsFor: 'initializing' stamp: 'cmm 8/11/2013 11:42'!session: aMagmaSession 	session := aMagmaSession.	aMagmaSession user ifNil: [ aMagmaSession user: (MagmaUser id: self printString) ].	aMagmaSession		 ensureConnected ;		 readStrategy: (MaReadStrategy minimumDepth: 0)! !!MagmaBufferController methodsFor: 'maui' stamp: 'cmm 3/18/2009 13:48'!mauiDefaultView	^ 'Access'! !"-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- "!MagmaBufferController class	instanceVariableNames: ''!!MagmaBufferController class methodsFor: 'create' stamp: 'cmm 3/17/2010 16:54'!location: aMagmaLocation 	^ self session:		(aMagmaLocation newSession			allowWriteBarrier: MagmaPreferences canEnableWriteBarrier ;			yourself)! !!MagmaBufferController class methodsFor: 'create' stamp: 'cmm 3/14/2009 14:53'!session: aMagmaSession	^ self new		session: aMagmaSession ;		yourself! !!MagmaBufferController class methodsFor: 'maui' stamp: 'cmm 3/18/2009 13:48'!mauiDefaultView	^ 'Create'! !MaObject subclass: #MagmaBufferFacade	instanceVariableNames: 'buffer commitRecord controller annotation'	classVariableNames: ''	poolDictionaries: ''	category: 'Magma-Tools-Buffer Editor'!!MagmaBufferFacade methodsFor: 'initializing' stamp: 'cmm 3/22/2005 22:47'!buffer: aMaObjectBuffer	buffer := aMaObjectBuffer! !!MagmaBufferFacade methodsFor: 'initializing' stamp: 'cmm 3/23/2005 13:10'!controller: aMagmaBufferController	controller := aMagmaBufferController! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/14/2009 18:14'!bufferAt: anInteger 	"Answer the buffer I reference at slot anInteger."	buffer isPointers ifFalse: [ ^ nil ].	^ MaOidCalculator 		objectWithOid: anInteger		ifNone: [ controller bufferAt: anInteger ]! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/18/2009 10:12'!buffersInSameCommit	"All the buffers in my commitPackage."	^ self commitPackage ifNotNilDo: 		[ : cp | 		| answer |		answer := OrderedCollection new.		cp objectsDo: 			[ : eachBuffer | 			answer add: (self class 					buffer: eachBuffer copyWithSameBuffer					controller: controller) ].		answer ]! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 2/20/2009 18:03'!classDefinition	^ controller 		classDefinitionFor: self classId		version: self classVersion! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/22/2005 23:12'!classId	^ buffer classId! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/22/2005 23:13'!classVersion	^ buffer classVersion! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 6/19/2013 13:12'!commitLogEntry	"The MaCommitLogEntry that contained this buffer."	^ self commitRecord ifNotNilDo: [ : cr | MagmaSession materializeCommitLogEntry: cr ]! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/14/2009 15:47'!commitNumber	^ buffer commitNumber! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/14/2009 15:56'!controller	"Answer the MagmaBufferController for this buffer."	^ controller! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/14/2009 16:55'!lastModified	"The DateAndTime of the server the time this object was last committed."	^ self commitRecord ifNotNilDo: [ : cr | cr timestamp ]! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/16/2014 19:33'!object	^ self session objectWithOid: self oid! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/22/2005 23:24'!objectClassName	^ controller objectClassNameFor: self classId! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/14/2009 15:35'!objectInstVarNames	^ self classDefinition allInstVarNames ! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/22/2005 23:12'!oid	^ buffer oid! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 8/27/2011 11:32'!referencedBuffers	^ buffer isPointers ifTrue:		[ (1 to: buffer objectInstSize) collect:			[ : index | self bufferAt: (buffer maInstVarAt: index) ] ]! !!MagmaBufferFacade methodsFor: 'access' stamp: 'cmm 3/16/2014 19:33'!session	^ controller session! !!MagmaBufferFacade methodsFor: 'printing' stamp: 'cmm 3/16/2014 19:26'!bufferPrintString	^ String streamContents:		[ : stream | stream			 maPrint: 'a ' ;			 maPrint: self objectClassName.		buffer isBytes ifTrue: [ stream maPrint: ' -- '. self objectClassName caseOf: {				[ #String ] -> 					[ stream						 maPrint: $' ;						 maPrint: buffer maAbbreviatedString ;						 maPrint: $' ]} ].				[ #ByteArray -> [ stream maPrint: self asByteArray maAbbreviatedString ]] ]! !!MagmaBufferFacade methodsFor: 'printing' stamp: 'cmm 3/22/2005 23:40'!printOn: aStream	super printOn: aStream.	buffer isBytes		ifTrue:			[ aStream nextPutAll: buffer asString ]		ifFalse:			[ self				maPrintAttributes: #(oid objectClassName)				on: aStream ]! !!MagmaBufferFacade methodsFor: 'private' stamp: 'cmm 3/14/2009 17:07'!commitPackage	"The MaCommitPackage that contained this buffer."	^ self commitLogEntry ifNotNilDo: [ : cle | cle commitPackage ]! !!MagmaBufferFacade methodsFor: 'private' stamp: 'cmm 3/23/2009 23:48'!commitRecord	"The MaCommitLogRecord that committed this buffer."self maMarked: 'performance'."This is bad for an old db with no commit-log file history, it'll keep trying over and over... :("	^ commitRecord ifNil: [ commitRecord := controller commitRecordAt: self commitNumber ]! !!MagmaBufferFacade methodsFor: 'maui' stamp: 'cmm 3/14/2009 17:35'!mauiDefaultColumns	^ #(#bufferPrintString #oid #lastModified #commitNumber )! !!MagmaBufferFacade methodsFor: 'maui' stamp: 'cmm 3/16/2014 18:14'!mauiDefaultView	^ 'References'! !!MagmaBufferFacade methodsFor: 'maui' stamp: 'cmm 3/14/2009 18:08'!mauiName	^ String streamContents: 		[ : stream | 		stream			maPrint: self oid ;			maPrint: ' - ' ;			maPrint: self bufferPrintString ]! !!MagmaBufferFacade methodsFor: 'maui' stamp: 'cmm 3/16/2014 18:12'!mauiSortableColumns	^ #(#bufferPrintString #oid #lastModified #commitNumber )! !"-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- "!MagmaBufferFacade class	instanceVariableNames: ''!!MagmaBufferFacade class methodsFor: 'create' stamp: 'cmm 3/22/2005 22:47'!buffer: aMaObjectBuffer controller: aMagmaRepositoryController	^ self new		buffer: aMaObjectBuffer ;		controller: aMagmaRepositoryController ;		yourself! !