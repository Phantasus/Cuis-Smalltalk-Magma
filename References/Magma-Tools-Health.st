MaObject subclass: #MagmaDoctor	instanceVariableNames: 'filer invalidClassDefinitionsBuffer invalidDefinitionBuffer invalidAnchorBuffer classIdOfDictionary'	classVariableNames: ''	poolDictionaries: ''	category: 'Magma-Tools-Health'!!MagmaDoctor commentStamp: 'cmm 3/25/2007 19:05' prior: 0!I present a report on a MagmaRepository.  I open the repository specified, report all of its primitive-attributes, then the contents and state of the crucial buffers (classDefinitions, anchor, definition).  If any of them do not look correct, I perform a scan of the object file, looking for them.!!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 14:19'!dataAttributes	^ { }! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 14:16'!headerAttributes	^ {  (TextEmphasis bold). (TextEmphasis underlined)  }! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 14:29'!invalid	^ '**INVALID**'! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 14:18'!labelAttributes	^ {  (TextEmphasis bold)  }! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:18'!looksLikeAnchorBuffer: aMaObjectBuffer 	| stream |	stream := WriteStream on: String new.	self 		printProblemsWithAnchorBuffer: aMaObjectBuffer		on: stream.	^ stream isEmpty! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/26/2007 23:01'!looksLikeClassDefinitionBuffer: aMaObjectBuffer	| stream |	stream := WriteStream on: String new.	self printProblemsWithClassDefinitionsBuffer: aMaObjectBuffer on: stream.	^ stream isEmpty! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:13'!looksLikeDefinitionBuffer: aMaObjectBuffer 	| stream |	stream := WriteStream on: String new.	self 		printProblemsWithDefinitionBuffer: aMaObjectBuffer		on: stream.	^ stream isEmpty! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:46'!printAnchorBufferOn: aWriteStream 	| buffer |	self 		printHeading: 'The Anchor Buffer'		on: aWriteStream.	buffer := self filer bufferFor: self filer anchorOid.	self 		printFieldNamed: 'oid'		value: buffer oid		on: aWriteStream.	self 		printFieldNamed: 'bufferType'		value: buffer bufferType		on: aWriteStream.	self 		printFieldNamed: #objectInstSize		value: buffer objectInstSize		on: aWriteStream.	self 		printFieldNamed: #classId		value: buffer classId		on: aWriteStream.	self 		printProblemsWithAnchorBuffer: buffer		on: aWriteStream."	invalidAnchorBuffer ifTrue: [ self printPotentialAnchorBuffersOn: aWriteStream ]"! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:12'!printClassDefinitionsBufferOn: aWriteStream 	| buffer |	self 		printHeading: 'The Class-Definitions Buffer'		on: aWriteStream.	buffer := self filer bufferFor: self filer classDefinitionsOid.	self 		printFieldNamed: 'oid'		value: buffer oid		on: aWriteStream.	self 		printFieldNamed: 'bufferType'		value: buffer bufferType		on: aWriteStream.	self 		printFieldNamed: #objectInstSize		value: buffer objectInstSize		on: aWriteStream.	self 		printFieldNamed: #classId		value: buffer classId		on: aWriteStream.	self 		printProblemsWithClassDefinitionsBuffer: buffer		on: aWriteStream.	invalidClassDefinitionsBuffer ifTrue: [ self printPotentialClassDefinitionsBuffersOn: aWriteStream ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 19:04'!printCrucialBuffersOn: aWriteStream 	self		printClassDefinitionsBufferOn: aWriteStream ;		printDefinitionBufferOn: aWriteStream ;		printAnchorBufferOn: aWriteStream! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:49'!printDefinitionBufferOn: aWriteStream 	| buffer |	self 		printHeading: 'The Repository-Definition Buffer'		on: aWriteStream.	buffer := self filer bufferFor: self filer definitionOid.	self 		printFieldNamed: 'oid'		value: buffer oid		on: aWriteStream.	self 		printFieldNamed: 'bufferType'		value: buffer bufferType		on: aWriteStream.	self 		printFieldNamed: #objectInstSize		value: buffer objectInstSize		on: aWriteStream.	self 		printFieldNamed: #classId		value: buffer classId		on: aWriteStream.	self 		printProblemsWithDefinitionBuffer: buffer		on: aWriteStream.	"invalidDefinitionBuffer ifTrue: [ self printPotentialDefinitionBuffersOn: aWriteStream ]"! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/26/2007 22:56'!printFieldNamed: aString value: anObject on: aWriteStream 	self 		printLabel: aString		value: anObject		withAttributes: self dataAttributes		on: aWriteStream! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 19:24'!printHeading: aString on: aWriteStream 	aWriteStream		cr ;		cr ;		withAttributes: self headerAttributes			do: [ aWriteStream maPrint: aString ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/26/2007 22:57'!printInvalidOn: aWriteStream withMessage: aString 	self 		printLabel: self invalid		value: aString		withAttributes: self problemAttributes		on: aWriteStream! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/26/2007 22:56'!printLabel: aString value: anObject withAttributes: attributes on: aWriteStream 	aWriteStream 		withAttributes: attributes		do: 			[ aWriteStream				cr ;				tab ;				maPrint: aString ;				maPrint: ':  ' ].	aWriteStream 		withAttributes: self dataAttributes		do: [ aWriteStream maPrint: anObject ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:28'!printPotentialAnchorBuffersOn: aWriteStream 	self 		printHeading: 'Candidates for the real AnchorBuffer'		on: aWriteStream.	self potentialAnchorBuffers do: 		[ : each | 		aWriteStream			cr ;			tab ;			maPrint: each ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:36'!printPotentialClassDefinitionsBuffersOn: aWriteStream 	self 		printHeading: 'Candidates for the real ClassDefinitions buffer'		on: aWriteStream.	self potentialClassDefinitionBuffers do: 		[ : each | 		aWriteStream			cr ;			tab ;			maPrint: each ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:36'!printPotentialDefinitionBuffersOn: aWriteStream 	self 		printHeading: 'Candidates for the real Definition buffer'		on: aWriteStream.	self potentialDefinitionBuffers do: 		[ : each | 		aWriteStream			cr ;			tab ;			maPrint: each ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 14:51'!printPrimitiveAttributesOn: aWriteStream 	self 		printHeading: 'Primitive Repository Values'		on: aWriteStream.	self		printSignatureOn: aWriteStream ;		printVersionOn: aWriteStream.	#(#classDefinitionsOid #definitionOid #anchorOid ) do: 		[ : each | 		self 			printSpecialOid: each			on: aWriteStream ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:20'!printProblemsWithAnchorBuffer: aMaObjectBuffer on: aWriteStream 	aMaObjectBuffer bufferType = MaFixedObjectBuffer basicNew bufferType ifFalse: 		[ invalidAnchorBuffer := true.		self 			printInvalidOn: aWriteStream			withMessage: 'The buffer should be a MaFixedObjectBuffer, it isn''t.' ].	aMaObjectBuffer objectInstSize = MaRootAnchor instSize ifFalse: 		[ invalidAnchorBuffer := true.		self 			printInvalidOn: aWriteStream			withMessage: 'This buffer should represent a MaRootAnchor, but its instSize isn''t right for that' ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:08'!printProblemsWithClassDefinitionsBuffer: aMaObjectBuffer on: aWriteStream 	| indexOfNonIntegerClassId indexOfInvalidUserOidClassDef |	aMaObjectBuffer bufferType = MaVariableObjectBuffer basicNew bufferType ifFalse: 		[ invalidClassDefinitionsBuffer := true.		self 			printInvalidOn: aWriteStream			withMessage: 'The buffer should be a MaVariableObjectBuffer, it isn''t.'.		^ self ].	(aMaObjectBuffer objectInstSize even and: [ aMaObjectBuffer objectInstSize > 0 ]) ifFalse: 		[ invalidClassDefinitionsBuffer := true.		self 			printInvalidOn: aWriteStream			withMessage: 'This buffer should represent a Dictionary, so it should always have an even objectInstSize (key->value pairs).'.		^ self ].	indexOfNonIntegerClassId := 0.	indexOfInvalidUserOidClassDef := 0.	aMaObjectBuffer instVarsDoWithIndex: 		[ : eachOid : index | 		index odd 			ifTrue: 				[ (MaOidCalculator isOidForOptimizedInteger: eachOid) ifFalse: [ indexOfNonIntegerClassId := index ] ]			ifFalse: 				[ (MaOidCalculator isOidForUserObject: eachOid) ifFalse: [ indexOfInvalidUserOidClassDef := index ] ] ].	indexOfNonIntegerClassId = 0 ifFalse: 		[ invalidClassDefinitionsBuffer := true.		self 			printInvalidOn: aWriteStream			withMessage: 'The class-definitions buffer should be a Dictionary with SmallIntegers as its keys.  This is not the case at instVar' , indexOfNonIntegerClassId printString ].	indexOfInvalidUserOidClassDef = 0 ifFalse: 		[ invalidClassDefinitionsBuffer := true.		self 			printInvalidOn: aWriteStream			withMessage: 'The class-definitions buffer should be a Dictionary user objects (MaClassDefinitions) as its values.  This is not the case at instVar' , indexOfInvalidUserOidClassDef printString ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/29/2007 15:12'!printProblemsWithDefinitionBuffer: aMaObjectBuffer on: aWriteStream 	aMaObjectBuffer bufferType = MaFixedObjectBuffer basicNew bufferType ifFalse: 		[ invalidDefinitionBuffer := true.		self 			printInvalidOn: aWriteStream			withMessage: 'The buffer should be a MaFixedObjectBuffer, it isn''t.' ].	aMaObjectBuffer objectInstSize = MagmaRepositoryDefinition instSize ifFalse: 		[ invalidDefinitionBuffer := true.		self 			printInvalidOn: aWriteStream			withMessage: 'This buffer should represent a MagmaRepositoryDefinition, but its instSize isn''t right for that' ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 13:31'!printRepositoryPathOn: aWriteStream 	aWriteStream		cr ;		maPrint: 'pathName:  ' ;		maPrint: self pathName! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 19:21'!printSignatureOn: aWriteStream 	self 		printFieldNamed: 'signature'		value: self filer signature		on: aWriteStream.	[ self filer validateSignature ] 		on: MagmaUserError		do: 			[ : err | 			self 				printInvalidOn: aWriteStream				withMessage: err messageText ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 19:31'!printSpecialOid: selectorSymbol on: aWriteStream 	self 		printFieldNamed: selectorSymbol		value: (self filer perform: selectorSymbol)		on: aWriteStream.	[ self filer validateSpecialOid: selectorSymbol ] 		on: MagmaCorruptionError		do: 			[ : err | 			self 				printInvalidOn: aWriteStream				withMessage: err messageText ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 14:53'!printTitleOn: aWriteStream 	aWriteStream 		withAttributes: { 				(TextAlignment centered).				(TextEmphasis underlined)			 }		do: [ aWriteStream maPrint: self pathName ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 19:21'!printVersionOn: aWriteStream 	self 		printFieldNamed: 'version'		value: self filer version		on: aWriteStream.	[ self filer validateVersion ] 		on: MagmaUserError		do: 			[ : err | 			self 				printInvalidOn: aWriteStream				withMessage: err messageText ]! !!MagmaDoctor methodsFor: 'private-report generation' stamp: 'cmm 3/25/2007 14:20'!problemAttributes	^ { TextColor red.  TextEmphasis bold }! !!MagmaDoctor methodsFor: 'private' stamp: 'cmm 5/11/2007 14:40'!filer	^ filer! !!MagmaDoctor methodsFor: 'private' stamp: 'cmm 3/29/2007 15:14'!potentialAnchorBuffers	| potentialAnswers |	potentialAnswers := OrderedCollection new.	self filer objectBuffersDo: 		[ : each | 		(self looksLikeAnchorBuffer: each) ifTrue: [ potentialAnswers add: each ] ].	^ potentialAnswers! !!MagmaDoctor methodsFor: 'private' stamp: 'cmm 3/29/2007 15:38'!potentialClassDefinitionBuffers	| potentialAnswers |	potentialAnswers := OrderedCollection new.	self filer objectBuffersDo: 		[ : each | 		(self looksLikeClassDefinitionBuffer: each) ifTrue: [ potentialAnswers add: each ] ].	(potentialAnswers collect: [ : e | e classId ]) asSet in: [ : classIds | classIds size = 1 ifTrue: [ classIdOfDictionary := classIds anyOne ] ].	^ potentialAnswers! !!MagmaDoctor methodsFor: 'private' stamp: 'cmm 3/29/2007 15:14'!potentialDefinitionBuffers	| potentialAnswers |	potentialAnswers := OrderedCollection new.	self filer objectBuffersDo: 		[ : each | 		(self looksLikeDefinitionBuffer: each) ifTrue: [ potentialAnswers add: each ] ].	^ potentialAnswers! !!MagmaDoctor methodsFor: 'initialize-release' stamp: 'cmm 3/25/2007 19:18'!filer: aMaObjectFiler	filer := aMaObjectFiler! !!MagmaDoctor methodsFor: 'initialize-release' stamp: 'cmm 3/29/2007 15:21'!initialize	super initialize.	invalidAnchorBuffer := invalidClassDefinitionsBuffer := invalidDefinitionBuffer := false! !!MagmaDoctor methodsFor: 'accessing' stamp: 'cmm 3/25/2007 19:19'!openHealthReport	| ts |	ts := TextStream on: Text new.	self writeHealthInformationTo: ts.	(Workspace new		contents: ts contents ;		yourself) openLabel: self pathName! !!MagmaDoctor methodsFor: 'accessing' stamp: 'cmm 5/11/2007 13:10'!pathName	^ filer directory pathName! !!MagmaDoctor methodsFor: 'accessing' stamp: 'cmm 3/25/2007 14:25'!writeHealthInformationTo: aWriteStream	self		printTitleOn: aWriteStream ;		printPrimitiveAttributesOn: aWriteStream ;		printCrucialBuffersOn: aWriteStream! !